name: Test Syndication API

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/test-syndication.yml'

jobs:
  test:
    name: Test Twitter Syndication
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Test syndication endpoint
        run: |
          echo "Testing syndication.twitter.com from GitHub Actions..."

          # Test with curl
          HTTP_STATUS=$(curl -s -o /tmp/syndication.html -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            "https://syndication.twitter.com/srv/timeline-profile/screen-name/Breaking911")

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response size: $(wc -c < /tmp/syndication.html) bytes"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Syndication works from GitHub Actions!"
            # Check if it has __NEXT_DATA__
            if grep -q '__NEXT_DATA__' /tmp/syndication.html; then
              echo "✅ __NEXT_DATA__ found in response"
              # Count entries
              ENTRIES=$(python3 -c "
import json, re, sys
html = open('/tmp/syndication.html').read()
m = re.search(r'<script id=\"__NEXT_DATA__\" type=\"application/json\">(.*?)</script>', html, re.DOTALL)
if m:
    data = json.loads(m.group(1))
    entries = data.get('props',{}).get('pageProps',{}).get('timeline',{}).get('entries',[])
    print(f'Entries: {len(entries)}')
    tweets = [e for e in entries if e.get('type')=='tweet']
    print(f'Tweets: {len(tweets)}')
    if tweets:
        t = tweets[0].get('content',{}).get('tweet',{})
        print(f'First tweet ID: {t.get(\"id_str\",\"?\")}')
        print(f'Content preview: {t.get(\"full_text\",\"?\")[:80]}')
else:
    print('No __NEXT_DATA__ match')
")
              echo "$ENTRIES"
            else
              echo "❌ No __NEXT_DATA__ in response"
              head -c 500 /tmp/syndication.html
            fi
          elif [ "$HTTP_STATUS" = "429" ]; then
            echo "❌ Rate limited (429) from GitHub Actions"
          else
            echo "❌ Failed with status $HTTP_STATUS"
            head -c 500 /tmp/syndication.html
          fi
