name: Test Syndication API

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/test-syndication.yml'

jobs:
  test:
    name: Test Twitter Syndication
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Test syndication endpoint
        run: |
          echo "Testing syndication.twitter.com from GitHub Actions..."

          HTTP_STATUS=$(curl -s -o /tmp/syndication.html -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            "https://syndication.twitter.com/srv/timeline-profile/screen-name/Breaking911")

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response size: $(wc -c < /tmp/syndication.html) bytes"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "SUCCESS: Syndication works from GitHub Actions!"
            if grep -q '__NEXT_DATA__' /tmp/syndication.html; then
              echo "SUCCESS: __NEXT_DATA__ found in response"
            else
              echo "FAIL: No __NEXT_DATA__ in response"
              head -c 500 /tmp/syndication.html
            fi
          elif [ "$HTTP_STATUS" = "429" ]; then
            echo "FAIL: Rate limited (429) from GitHub Actions"
          else
            echo "FAIL: HTTP $HTTP_STATUS"
            head -c 500 /tmp/syndication.html
          fi
